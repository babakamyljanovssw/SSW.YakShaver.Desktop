name: PR Pre-release

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to build"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  APP_NAME: SSW.YakShaver
  NODE_VERSION: 20

jobs:
  cleanup-release:
    if: |
      github.event_name != 'pull_request' ||
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr_info.outputs.pr_number }}
      release_tag: ${{ steps.pr_info.outputs.tag }}
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          TAG_NAME="pr-${PR_NUMBER}"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "PR: ${PR_NUMBER}, Tag: ${TAG_NAME}"

      - name: Delete existing release assets
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.pr_info.outputs.tag }}"
          
          echo "Checking for existing release: ${TAG}"
          
          # Try to get the release
          RELEASE=$(gh api /repos/${{ github.repository }}/releases/tags/$TAG 2>/dev/null || echo "")
          
          if [ -n "$RELEASE" ]; then
            echo "Found existing release, deleting all assets..."
            
            # Get all asset IDs and delete them
            echo "$RELEASE" | jq -r '.assets[].id' | while read -r asset_id; do
              if [ -n "$asset_id" ]; then
                ASSET_NAME=$(echo "$RELEASE" | jq -r ".assets[] | select(.id == $asset_id) | .name")
                echo "Deleting asset: $ASSET_NAME (ID: $asset_id)"
                gh api -X DELETE /repos/${{ github.repository }}/releases/assets/$asset_id || true
              fi
            done
            
            echo "All assets deleted successfully"
          else
            echo "No existing release found - this is a new release"
          fi

  build-windows:
    needs: cleanup-release
    if: |
      github.event_name != 'pull_request' ||
      github.event.action != 'closed'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      # TODO: Remove this step once this PBI is done: https://github.com/SSWConsulting/SSW.YakShaver/issues/3095
      - name: Create .env from secrets
        shell: pwsh
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        run: |
          "YOUTUBE_CLIENT_ID=$env:YOUTUBE_CLIENT_ID" | Out-File -FilePath ".env" -Encoding utf8 -NoNewline
          Add-Content -Path ".env" -Value "`nYOUTUBE_CLIENT_SECRET=$env:YOUTUBE_CLIENT_SECRET"

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Install UI dependencies
        run: npm ci --prefer-offline
        working-directory: src/ui

      - name: Get PR info
        id: pr_info
        run: |
          $prNumber = "${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          $prSha = "${{ github.event.pull_request.head.sha || github.sha }}"
          $shortSha = $prSha.Substring(0, 7)
          $tagName = "pr-$prNumber"
          echo "tag=$tagName" >> $env:GITHUB_OUTPUT
          echo "pr_number=$prNumber" >> $env:GITHUB_OUTPUT
          echo "pr_sha=$shortSha" >> $env:GITHUB_OUTPUT

      - name: Update version for pre-release
        shell: pwsh
        run: |
          $prNumber = "${{ steps.pr_info.outputs.pr_number }}"
          if (-not $prNumber) {
            throw "Missing PR number output"
          }
          $baseVersion = (node -p 'require("./package.json").version.split("-")[0]').Trim()
          $preReleaseVersion = "$baseVersion-pr.$prNumber"

          npm version $preReleaseVersion --no-git-tag-version

      - name: Publish Windows pre-release
        run: npm run publish -- --win --publish never
        env:
          NODE_ENV: production
          CI: true
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy update manifest for channel
        shell: pwsh
        run: |
          $tagName = "${{ steps.pr_info.outputs.tag }}"
          if (Test-Path "build/latest.yml") {
            Copy-Item "build/latest.yml" "build/$tagName.yml"
            Write-Host "Created build/$tagName.yml"
          }

      - name: Create or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.pr_info.outputs.tag }}
          name: "Pre-release PR #${{ steps.pr_info.outputs.pr_number }} (${{ steps.pr_info.outputs.pr_sha }})"
          body: |
            Pre-release build for PR #${{ steps.pr_info.outputs.pr_number }}
            
            Commit: ${{ steps.pr_info.outputs.pr_sha }}
            PR: ${{ github.event.pull_request.html_url || 'N/A' }}
            
            This is an automated pre-release. It will be updated automatically when new commits are pushed to the PR.
          prerelease: true
          files: |
            build/latest.yml
            build/${{ steps.pr_info.outputs.tag }}.yml
            build/YakShaver Setup*.exe
            build/YakShaver Setup*.exe.blockmap
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: cleanup-release
    if: |
      github.event_name != 'pull_request' ||
      github.event.action != 'closed'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      # TODO: Remove this step once this PBI is done: https://github.com/SSWConsulting/SSW.YakShaver/issues/3095
      - name: Create .env from secrets
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        run: |
          printf "YOUTUBE_CLIENT_ID=%s\nYOUTUBE_CLIENT_SECRET=%s\n" "$YOUTUBE_CLIENT_ID" "$YOUTUBE_CLIENT_SECRET" > .env

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Install UI dependencies
        run: npm ci --prefer-offline
        working-directory: src/ui

      - name: Get PR info
        id: pr_info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          PR_SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          SHORT_SHA="${PR_SHA:0:7}"
          TAG_NAME="pr-${PR_NUMBER}"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Update version for pre-release
        run: |
          PR_NUMBER="${{ steps.pr_info.outputs.pr_number }}"
          if [[ -z "$PR_NUMBER" ]]; then
            echo "Missing PR number output"
            exit 1
          fi
          BASE_VERSION=$(node -p 'require("./package.json").version.split("-")[0]')
          PRE_RELEASE_VERSION="${BASE_VERSION}-pr.${PR_NUMBER}"

          npm version "$PRE_RELEASE_VERSION" --no-git-tag-version

      - name: Publish macOS pre-release
        run: npm run publish -- --mac --publish never
        env:
          NODE_ENV: production
          CI: true
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy update manifest for channel
        run: |
          TAG_NAME="${{ steps.pr_info.outputs.tag }}"
          if [ -f "build/latest-mac.yml" ]; then
            cp "build/latest-mac.yml" "build/$TAG_NAME-mac.yml"
            echo "Created build/$TAG_NAME-mac.yml"
          fi

      - name: Create or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.pr_info.outputs.tag }}
          name: "Pre-release PR #${{ steps.pr_info.outputs.pr_number }} (${{ steps.pr_info.outputs.pr_sha }})"
          body: |
            Pre-release build for PR #${{ steps.pr_info.outputs.pr_number }}
            
            Commit: ${{ steps.pr_info.outputs.pr_sha }}
            PR: ${{ github.event.pull_request.html_url || 'N/A' }}
            
            This is an automated pre-release. It will be updated automatically when new commits are pushed to the PR.
          prerelease: true
          files: |
            build/YakShaver-*-mac.zip
            build/YakShaver-*-mac.zip.blockmap
            build/latest-mac.yml
            build/${{ steps.pr_info.outputs.tag }}-mac.yml
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}

  comment-release:
    runs-on: ubuntu-latest
    needs:
      - cleanup-release
      - build-windows
      - build-macos
    if: |
      github.event.action != 'closed' &&
      needs.cleanup-release.outputs.pr_number != ''
    steps:
      - name: Comment release link on PR
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ needs.cleanup-release.outputs.pr_number }}
          body: |
            ðŸš€ Pre-release build is available for this PR:
            https://github.com/${{ github.repository }}/releases/tag/${{ needs.cleanup-release.outputs.release_tag }}

  delete-release:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed'
    steps:
      - name: Delete PR pre-release
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const tagName = `pr-${prNumber}`;

            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName,
              });

              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
              });

              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`,
              });

              core.info(`Deleted release and tag for ${tagName}`);
            } catch (error) {
              if (error.status === 404) {
                core.info(`Release or tag ${tagName} not found; nothing to delete.`);
              } else {
                core.setFailed(`Failed to delete release ${tagName}: ${error.message}`);
              }
            }

